<!-- [START calendar_quickstart] -->
<!DOCTYPE html>
<html>
<head>
    <title>Google Calendar API Quickstart</title>
    <meta charset="utf-8" />

    <link rel="stylesheet" href="https://fengyuanchen.github.io/datepicker/css/datepicker.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://fengyuanchen.github.io/datepicker/js/datepicker.js"></script>
    <script src="https://fengyuanchen.github.io/datepicker/js/datepicker.ja-JP.js"></script>

</head>
<body>
    <p>Google Calendar API Quickstart</p>

    <!-- 日程調整の区間を決定 カレンダー入力 -->
    <div id="determine_adjust_dates" style="display:none">
        <p>日程調整の期間を決定してください</p>
        <p>
            <input type="text" id="date_start_y" value="2020">/
            <input type="text" id="date_start_m" value="06">/
            <input type="text" id="date_start_d" value="15">~
        </p>
        <p>
            <input type="text" id="date_end_y" value="2020">/
            <input type="text" id="date_end_m" value="06">/
            <input type="text" id="date_end_d" value="30">
        </p>
        <button id="submit-adjust-dates" onClick="sendAdjustDates()">Submit!</button>
    </div>

    <!-- グーグルAuthorizeして勝手にカレンダー入力 -->
    <div id="fill_in_dates" style="display:none">
        <p id="adjust-dates-show">日程調整の期間: </p>
        <button id="submit_your_dates" onClick="sendYourDates()">あなたの日程の情報を送る</button>
        <button id="authorize_button" style="display: none;">Authorize and Automatic Fill in</button>
        <button id="signout_button" style="display: none;">Sign Out</button>
    </div>

    <!-- 日程調整の結果を表示 -->
    <div id="result" style="display:none">

    </div>


    <!--Add buttons to initiate auth sequence and sign out-->

    <pre id="content" style="white-space: pre-wrap;"></pre>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous"></script>
    <script type="text/javascript">
        //現在の日付を習得しておく
        var today = new Date();

        //使用時は必ず
        //$('[data-toggle="datepicker"]').datepicker()
        //と書くこと。


        // Client ID and API key from the Developer Console
        //var CLIENT_ID = '<YOUR_CLIENT_ID>';
        //var API_KEY = '<YOUR_API_KEY>';
        //var PROJECT_ID = 'igneous-day-280906';
        var CLIENT_ID = '585131480177-42chhkgvtk86re4k9g3l665k5tfil0ag.apps.googleusercontent.com';
        var API_KEY = 'AIzaSyBHlrugWkURBFW8rBTRP6YpMkO1RrZHI78';

        // Array of API discovery doc URLs for APIs used by the quickstart
        var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];

        // Authorization scopes required by the API; multiple scopes can be
        // included, separated by spaces.
        var SCOPES = "https://www.googleapis.com/auth/calendar.readonly";

        var authorizeButton = document.getElementById('authorize_button');
        var signoutButton = document.getElementById('signout_button');



        //const endpoint = "https://script.google.com/macros/s/AKfycbzO4XVTP61ideHo0dcY_nco-LxZExmlwWygfnavESuB12WEmRMN/exec";
        //$.ajax({
        //    type: 'GET',
        //    url: endpoint,
        //    dataType: 'jsonp',
        //    data: {
        //        "id": "3",
        //        "flg": "1",
        //        "username": "yuri",
        //        "dates": ""
        //    },
        //    success: out => {
        //        alert(out.message);
        //    }
        //});


        /* まずidの有無を調べる */
        var id = getParam('id'); // 日程調整のid
        var flg;
        var username = "";
        var dates = "";
        if (id == null || id == "") { // idが無い場合日程調整の初期決定をさせるを行わせる
            console.log("id nothing");
            flg = 1;
            $("#determine_adjust_dates").show();
            //document.getElementById('submit-adjust-dates').onclick(sendAdjustDates);
        } else {
            var result = getParam('result');
            if (result == "true" || result == true) {

                // 結果を表示
                flg = 3;
                $("#result").show();
                getAdjustResult();
            } else {
                $("#fill_in_dates").show();
                console.log("id: ", id);
                /* idで区間を取ってくる */
                const endpoint = "https://script.google.com/macros/s/AKfycbzO4XVTP61ideHo0dcY_nco-LxZExmlwWygfnavESuB12WEmRMN/exec";
                $.ajax({
                    type: 'GET',
                    url: endpoint,
                    dataType: 'jsonp',
                    data: {
                        "id": String(id),
                        "flg": "2",
                        "username": "",
                        "dates": ""
                    },
                    success: out => {
                        dates = out.dates;
                        // 日程調整の期間を表示する
                        var dates_ = dates.split('-');
                        var unix0 = dates_[0];
                        var unix1 = dates_[1];
                        console.log("unix0", unix0);
                        console.log("unix1", unix1);
                        var date0 = new Date(parseInt(unix0));
                        var date1 = new Date(parseInt(unix1));
                        console.log("date0", date0);
                        console.log("date1", date1);

                        var date0str = date0.getFullYear() + "/" + date0.getMonth() + "/" + date0.getDate();
                        var date1str = date1.getFullYear() + "/" + date1.getMonth() + "/" + date1.getDate();
                        $('#adjust-dates-show').text("日程調整の期間: " + date0str + " - " + date1str);
                    },
                });

                // 次にログイン情報の無い場合はログインさせる
                // ログインされた状態の場合，日程を確認して送信させる



            }
        }

        function getAdjustResult() {
            /* 日程調整結果を得る */
            $.ajax({
                type: 'GET',
                url: "https://script.google.com/macros/s/AKfycbzO4XVTP61ideHo0dcY_nco-LxZExmlwWygfnavESuB12WEmRMN/exec",
                dataType: 'jsonp',
                data: {
                    "id": String(id),
                    "flg": "4",
                    "username": "",
                    "dates": ""
                },
                success: out => {
                    var dates = out.dates;
                    // 1列目は日程調整しようとした期間が入ってる
                    for (var i = 0; i < dates.length; ++i) {
                        var date0 = new Date(dates[i][0]);
                        var date1 = new Date(dates[i][1]);
                        console.log("date0", date0);
                        console.log("date1", date1);

                        var date0str = formatting(date0);
                        var date1str = formatting(date1);
                        //var date0str = date0.getFullYear() + "/" + date0.getMonth() + "/" + date0.getDate() + " " + date0.getHours() + ":" + date0.getMinutes();
                        //var date1str = date1.getFullYear() + "/" + date1.getMonth() + "/" + date1.getDate() + " " + date1.getHours() + ":" + date1.getMinutes();
                        if (i == 0) {
                            appendPre("日程調整の結果: (" + date0str + " - " + date1str + ")");

                        } else appendPre(date0str + " - " + date1str);

                    }
                    /* GoogleアカウントのAuthorizeをして，結果をSpreadsheetに出力 */
                    //handleClientLoad();
                }
            });
        }

        function formatting(d) {
            var y = d.getFullYear();
            var month = d.getMonth();
            var m = ('00' + month).slice(-2);
            var day = d.getDate();
            var date = ('00' + day).slice(-2);
            var hour = d.getHours();
            var h = ('00' + hour).slice(-2);
            var min = d.getMinutes();
            var mm = ('00' + min).slice(-2);
            var str = y + "/" + m + "/" + date + " " + h + ":" + mm;
            return str;
        }

        function sendAdjustDates() {
            const endpoint = "https://script.google.com/macros/s/AKfycbzO4XVTP61ideHo0dcY_nco-LxZExmlwWygfnavESuB12WEmRMN/exec";
            console.log("submit");
            var y0 = document.getElementById("date_start_y").value;
            var m0 = document.getElementById("date_start_m").value;
            var d0 = document.getElementById("date_start_d").value;
            var y1 = document.getElementById("date_end_y").value;
            var m1 = document.getElementById("date_end_m").value;
            var d1 = document.getElementById("date_end_d").value;
            var day0 = new Date(parseInt(y0), parseInt(m0), parseInt(d0), 0, 0, 0);
            var day1 = new Date(parseInt(y1), parseInt(m1), parseInt(d1), 23, 59, 59);
            console.log(day0);
            console.log(day1);
            var unix0 = day0.getTime();
            var unix1 = day1.getTime();

            /* 区間を送信する */
            $.ajax({
                type: 'GET',
                url: endpoint,
                dataType: 'jsonp',
                data: {
                    "id": "",
                    "flg": "1",
                    "username": "",
                    "dates": unix0 + "-" + unix1
                },
                success: out => {
                    id = out.id; // idを取ってきた
                    console.log("generated id: ", id);

                    // ページを切り替える
                    window.location.href = "https://xsmiledur.github.io/entredojo-auto-choseisan-github.io/?id=" + String(id);

                }
            });
        }

        function sendYourDates() {
            // カレンダーから情報を取ってくる
            gapi.client.calendar.events.list({
                'calendarId': 'primary',
                'timeMin': (new Date()).toISOString(),
                'showDeleted': false,
                'singleEvents': true,
                'maxResults': 10,
                'orderBy': 'startTime'
            }).then(function (response) {
                var events = response.result.items;
                var timestr = "";

                if (events.length > 0) {
                    for (i = 0; i < events.length; i++) {
                        var event = events[i];
                        var when = event.start.dateTime;
                        var y, m, d, h, min, mm;
                        var sta, end;
                        if (!when) {
                            when = event.start.date;
                            var ymd = when.split('-');
                            y = ymd[0];
                            m = ymd[1];
                            d = ymd[2];
                            h = min = mm = 0;
                            sta = new Date(y, m, d, 0, 0, 0);
                            end = new Date(y, m, d, 23, 59, 59);
                        } else {
                            var str = when.split('T');
                            var ymd = str[0].split('-');
                            y = ymd[0];
                            m = ymd[1];
                            d = ymd[2];
                            var staend = str[1].split('+');
                            var staT = staend[0].split(':');
                            var endT = staend[1].split(':');
                            sta = new Date(y, m, d, staT[0], staT[1], staT[2]);
                            end = new Date(y, m, d, parseInt(staT[0]) + parseInt(endT[0]), parseInt(staT[1]) + parseInt(endT[1]), parseInt(staT[2]));
                        }
                        console.log("sta", sta, "end", end);
                        var staunix = sta.getTime();
                        var endunix = end.getTime();
                        console.log("unix", staunix, endunix);
                        timestr += staunix + "-" + endunix + ",";
                    }
                }

                // datesの区間内で当該ユーザのイベントを取っていく
                const endpoint = "https://script.google.com/macros/s/AKfycbzO4XVTP61ideHo0dcY_nco-LxZExmlwWygfnavESuB12WEmRMN/exec";
                console.log("search id:", id);
                $.ajax({
                    type: 'GET',
                    url: endpoint,
                    dataType: 'jsonp',
                    data: {
                        "id": String(id),
                        "flg": "3",
                        "username": "anonymous",
                        "dates": timestr
                    },
                    success: out => {
                        dates = out.dates; // 当該ユーザのイベントを取ってくる
                        console.log(dates);
                    }
                });
                window.location.href = "https://xsmiledur.github.io/entredojo-auto-choseisan-github.io/?id=" + String(id) + "&result=true";


            //    console.log("submit");
            //    var y0 = document.getElementById("date_start_y").value;
            //    var m0 = document.getElementById("date_start_m").value;
            //    var d0 = document.getElementById("date_start_d").value;
            //    var y1 = document.getElementById("date_end_y").value;
            //    var m1 = document.getElementById("date_end_m").value;
            //    var d1 = document.getElementById("date_end_d").value;
            //    var day0 = new Date(y0, m0, d0, 0, 0, 0);
            //    var day1 = new Date(y1, m1, d1, 23, 59, 59);
            //    console.log(day0);
            //    console.log(day1);
            //    var unix0 = day0.getTime();
            //    var unix1 = day1.getTime();

            //    /* 区間を送信する */
            //    $.ajax({
            //        type: 'GET',
            //        url: "https://script.google.com/macros/s/AKfycbzO4XVTP61ideHo0dcY_nco-LxZExmlwWygfnavESuB12WEmRMN/exec",
            //        dataType: 'jsonp',
            //        data: {
            //            "id": "",
            //            "flg": "1",
            //            "username": "",
            //            "dates": unix0 + "-" + unix1
            //        },
            //        success: out => {
            //            id = out.id; // idを取ってきた
            //            console.log("generated id: ", id);


            //            window.location.href = "https://xsmiledur.github.io/entredojo-auto-choseisan-github.io/?id=" + String(id) + "&result=true";

            //        }
            //    });

            });

        }

        /**
         * Get the URL parameter value
         *
         * @param  name {string} パラメータのキー文字列
         * @return  url {url} 対象のURL文字列（任意）
         */
        function getParam(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        /**
         *  On load, called to load the auth2 library and API client library.
         */
        function handleClientLoad() {
            gapi.load('client:auth2', initClient);
        }

        /**
         *  Initializes the API client library and sets up sign-in state
         *  listeners.
         */
        function initClient() {
            gapi.client.init({
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                discoveryDocs: DISCOVERY_DOCS,
                scope: SCOPES
            }).then(function () {
                // Listen for sign-in state changes.
                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

                // Handle the initial sign-in state.
                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
                authorizeButton.onclick = handleAuthClick;
                signoutButton.onclick = handleSignoutClick;
            }, function (error) {
                appendPre(JSON.stringify(error, null, 2));
            });
        }

        /**
         *  Called when the signed in status changes, to update the UI
         *  appropriately. After a sign-in, the API is called.
         */
        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                authorizeButton.style.display = 'none';
                signoutButton.style.display = 'block';
                listUpcomingEvents();
            } else {
                authorizeButton.style.display = 'block';
                signoutButton.style.display = 'none';
            }
        }

        /**
         *  Sign in the user upon button click.
         */
        function handleAuthClick(event) {
            gapi.auth2.getAuthInstance().signIn();
        }

        /**
         *  Sign out the user upon button click.
         */
        function handleSignoutClick(event) {
            gapi.auth2.getAuthInstance().signOut();
        }

        /**
         * Append a pre element to the body containing the given message
         * as its text node. Used to display the results of the API call.
         *
         * @param {string} message Text to be placed in pre element.
         */
        function appendPre(message) {
            var pre = document.getElementById('content');
            var textContent = document.createTextNode(message + '\n');
            pre.appendChild(textContent);
        }

        /**
         * Print the summary and start datetime/date of the next ten events in
         * the authorized user's calendar. If no events are found an
         * appropriate message is printed.
         */
        function listUpcomingEvents() {
            gapi.client.calendar.events.list({
                'calendarId': 'primary',
                'timeMin': (new Date()).toISOString(),
                'showDeleted': false,
                'singleEvents': true,
                'maxResults': 10,
                'orderBy': 'startTime'
            }).then(function (response) {
                var events = response.result.items;
                appendPre('あなたのイベント');

                if (events.length > 0) {
                    for (i = 0; i < events.length; i++) {
                        var event = events[i];
                        var when = event.start.dateTime;
                        if (!when) {
                            when = event.start.date;
                        }
                        appendPre(event.summary + ' (' + when + ')')
                    }
                } else {
                    appendPre('あなたの予定されたイベントはありません');
                }
            });
        }

    </script>

    <script async defer src="https://apis.google.com/js/api.js"
            onload="this.onload = function () { }; handleClientLoad();"
            onreadystatechange="if (this.readyState === 'complete') this.onload()"></script>
</body>
</html>
<!-- [END calendar_quickstart] -->
